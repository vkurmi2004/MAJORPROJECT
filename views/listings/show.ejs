<% layout('layouts/boilerplate') %>

<div class="container mt-5">
  <div class="row">

    <!-- IMAGE -->
    <div class="col-md-7">
      <img
        src="<%= listing.image?.url || 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e' %>"
        class="img-fluid rounded"
        style="height:400px; width:100%; object-fit:cover;"
        alt="Listing image"
      >
    </div>

    <!-- DETAILS -->
    <div class="col-md-5">
      <h2><%= listing.title %></h2>

      <p class="text-muted">
        <%= listing.location %>, <%= listing.country %>
      </p>

      <i>
        Hosted by
        <%= listing.owner ? listing.owner.username : 'Unknown host' %>
      </i>

      <p class="mt-3"><%= listing.description %></p>

      <h4 class="text-danger">
        ₹<%= listing.price.toLocaleString("en-IN") %> / night
      </h4>

      <!-- OWNER CONTROLS -->
      <% if (currentUser && listing.owner && listing.owner._id.equals(currentUser._id)) { %>
        <div class="mt-3">
          <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning btn-sm">
            Edit Listing
          </a>

          <form
            action="/listings/<%= listing._id %>?_method=DELETE"
            method="POST"
            class="d-inline"
          >
            <button class="btn btn-danger btn-sm">
              Delete
            </button>
          </form>
        </div>
      <% } %>
    </div>

    <!-- MAP -->
    <div class="col-md-8 offset-md-2 mt-5">
      <hr>
      <h4>Where you’ll be</h4>

      <% if (listing.geometry && listing.geometry.coordinates?.length) { %>
        <div id="map" style="height:400px;" class="rounded shadow"></div>
      <% } else { %>
        <p class="text-muted">Location map not available.</p>
      <% } %>
    </div>

    <!-- REVIEWS -->
    <div class="col-md-8 offset-md-2 mt-5">
      <hr>
      <h4>Guest Reviews</h4>

      <% if (listing.reviews.length === 0) { %>
        <p class="text-muted">No reviews yet.</p>
      <% } %>

      <% listing.reviews.forEach(review => { %>
        <div class="border rounded p-3 mb-3">
          <strong>⭐ <%= review.rating %>/5</strong>

          <p><%= review.comment %></p>

          <small class="text-muted">
            by <%= review.author ? review.author.username : 'Anonymous' %>
          </small>

          <% if (currentUser && review.author && review.author._id.equals(currentUser._id)) { %>
            <form
              action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
              method="POST"
              class="mt-2"
            >
              <button class="btn btn-sm btn-outline-danger">
                Delete Review
              </button>
            </form>
          <% } %>
        </div>
      <% }) %>
    </div>

  </div>
</div>

<!-- MAP SCRIPT -->
<% if (listing.geometry && listing.geometry.coordinates?.length) { %>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const lng = "<%= listing.geometry.coordinates[0] %>";
    const lat = "<%= listing.geometry.coordinates[1] %>";

    const map = L.map('map').setView([lat, lng], 13);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    L.marker([lat, lng])
      .addTo(map)
      .bindPopup("<%= listing.title %>")
      .openPopup();
  </script>
<% } %>
<!-- END MAP SCRIPT -->